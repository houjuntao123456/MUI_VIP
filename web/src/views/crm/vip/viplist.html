<title>会员列表</title>

<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-body">

                    <table class="layui-hide" id="crm-vip-viplist-list" lay-filter="crm-vip-viplist-list"></table>

                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/html" id="vip-viplist-toolbarDemo">
    <div class="layui-btn-container">
        <div class="layui-btn layui-btn-sm" id="crm-vip-viplist-transfer">会员转移</div>
        <div class="layui-btn layui-btn-sm" id="viplist-batch-editing">批量编辑会员标签</div>
        <div class="layui-btn layui-btn-sm layui-btn-normal" id="crm-vip-viplist-addscreen">高级筛选</div>
    </div>
</script>
<script src="/libs/js/jquery.js" type="text/javascript" charset="utf-8"></script>
<script src="/libs/js/citys.js" type="text/javascript" charset="utf-8"></script>
<script>
    layui.use(['admin', 'element', 'table', 'form', 'upload', 'cascader', 'checkbox', 'laydate'], function () {
        var $ = layui.$
            , admin = layui.admin
            , element = layui.element
            , table = layui.table
            , form = layui.form
            , upload = layui.upload
            , laydate = layui.laydate
            , checkbox = layui.checkbox
            , cascader = layui.cascader
            , router = layui.router();

        var viplist = function (screen = false, sizer = false) {
            admin.req({
                url: '/index.php/webVipListExt/', //数据接口路由
                type: 'post',
                done: function (res) {
                    var json = res.data;
                    var tabledata_arr = new Array();
                    var cols_arr = new Array();
                    tabledata_arr.push({ type: 'checkbox', fixed: 'left' }
                        , { field: 'code', width: 100, title: '会员卡号', align: 'center', sort: true, fixed: 'left' }
                        , { field: 'username', width: 160, title: '会员姓名', align: 'center', sort: true, fixed: 'left' }
                        , { field: 'sex', width: 160, title: '性别', align: 'center', sort: true }
                        , { field: 'vlname', width: 160, title: '会员级别', align: 'center', sort: true }
                        , { field: 'phone', width: 160, title: '手机号码', align: 'center', sort: true }
                        , { field: 'telephone', width: 160, title: '固定电话', align: 'center', sort: true }
                        , { field: 'identity', width: 160, title: '身份证号码', align: 'center', sort: true }
                        , { field: 'nation', width: 160, title: '民族', align: 'center', sort: true }
                        , { field: 'birthday', width: 160, title: '会员生日', align: 'center', sort: true }
                        , { field: 'calendar', width: 160, title: '公历/农历', align: 'center' }
                        , { field: 'vsname', width: 160, title: '所属门店', align: 'center', sort: true }
                        , { field: 'vrname', width: 160, title: '登记门店', align: 'center', sort: true }
                        , { field: 'vgname', width: 160, title: '形象顾问', align: 'center', sort: true }
                        , { field: 'activate_name', width: 160, title: '开卡人', align: 'center', sort: true }
                        , { field: 'introducer_code', width: 160, title: '介绍人卡号', align: 'center', sort: true }
                        , { field: 'introducer_name', width: 160, title: '介绍人', align: 'center' }
                        , { field: 'adult_code', width: 160, title: '提成人', align: 'center', sort: true }
                        , { field: 'acs', width: 160, title: '入会费', align: 'center', sort: true }
                        , { field: 'initiation', width: 160, title: '入会方式', align: 'center' }
                        , { field: 'qq', width: 160, title: 'QQ', align: 'center', sort: true }
                        , { field: 'weixin', width: 160, title: '微信', align: 'center', sort: true }
                        , { field: 'area', width: 160, title: '所属地区', align: 'center' }
                        , { field: 'address', width: 160, title: '详细地址', align: 'center', sort: true }
                        , { field: 'payment_method', width: 160, title: '支付方式', align: 'center' }
                        , { field: 'consumption_times', width: 160, title: '消费次数', align: 'center', sort: true }
                        , { field: 'consumption_number', width: 160, title: '消费件数', align: 'center', sort: true }
                        , { field: 'exchange_number', width: 160, title: '兑换次数', align: 'center' }
                        , { field: 'total_consumption', width: 160, title: '总消费额', align: 'center', sort: true }
                        , { field: 'first_time', width: 160, title: '首次购物时间', align: 'center', sort: true }
                        , { field: 'final_purchases', width: 160, title: '最后购物时间', align: 'center' }
                        , { field: 'days', width: 160, title: '消费天数', align: 'center' }
                        , { field: 'years', width: 160, title: '消费年数', align: 'center' }
                        , { field: 'r_days', width: 160, title: '未消费天数', align: 'center' }
                        , { field: 'residual_integral', width: 160, title: '剩余总积分', align: 'center' }
                        , { field: 'already_used_integral', width: 160, title: '已用积分', align: 'center', sort: true }
                        , { field: 'offset_integral', width: 160, title: '剩余抵现积分', align: 'center', sort: true }
                        , { field: 'gift_integral', width: 160, title: '剩余礼品积分', align: 'center' }
                        , { field: 'total_integral', width: 160, title: '总积分', align: 'center', sort: true }
                        , { field: 'stored_value', width: 160, title: '已用储值', align: 'center', sort: true }
                        , { field: 'residual_value', width: 160, title: '剩余储值', align: 'center' }
                        , { field: 'total_value', width: 160, title: '总储值', align: 'center', sort: true }
                        , { field: 'total_frozen_value', width: 160, title: '总冻结储值', align: 'center', sort: true });
                    for (var i = 0, l = json.length; i < l; i++) {
                        tabledata_arr.push({ field: json[i], width: 140, title: json[i], align: 'center', sort: true });
                    }
                    tabledata_arr.push({ field: 'remarks', width: 160, title: '备注', align: 'center', sort: true });
                    tabledata_arr.push({ fixed: 'right', width: 160, title: '操作', align: 'center', toolbar: '#crm-vip-viplist-barDemo' });
                    cols_arr.push(tabledata_arr);

                    table.render({
                        elem: '#crm-vip-viplist-list',
                        height: 'full-150',
                        url: '/index.php/webVipList/',
                        id: "vipList",
                        page: true, //开启分页
                        limit: 20,
                        limits: [20, 50, 100, 200, 500],
                        where: {
                            screen: screen,
                            sizer: sizer,
                            access_token: layui.data(layui.setter.tableName).access_token
                        },
                        cols: cols_arr,
                        toolbar: '#vip-viplist-toolbarDemo'
                    });

                    $("#crm-vip-viplist-transfer").click(function () { // ---------------------------------------------------------会员转移
                        var num = table.checkStatus('vipList').data.length;
                        if (num == 0) {
                            layer.msg('请选择要转移的会员', { icon: 7, title: '警告' });
                            return false;
                        }
                        layer.open({
                            title: "会员转移"
                            , type: 1
                            , shade: 0.3
                            , shadeClose: false
                            , anim: 1
                            , offset: 'auto'
                            , area: ["550px", "350px"]
                            , skin: "layui-layer-admin layui-anim"
                            , content: '<form class="layui-form layui-form-pane" action="" lay-filter="vip-viplist-transfer"><div class="layui-form-item"><label class="layui-form-label">形象顾问</label><div class="layui-input-block"><select name="vip-viplist-transfer-xxgw" id="vip-viplist-transfer-xxgw" lay-search lay-filter="vip-viplist-transfer-xxgw"></select></div></div><div class="layui-form-item"><label class="layui-form-label">所属门店</label><div class="layui-input-block"><select name="vip-viplist-transfer-ssmd" id="vip-viplist-transfer-ssmd" lay-search lay-filter="vip-viplist-transfer-ssmd"></select></div></div><div class="layui-form-item"><div style="text-align:center"><div class="layui-btn layui-btn-radius" id="Confirmation_transfer" lay-filter="Confirmation_transfer">确认转移</div></div></div></form>'
                            , success: function (layero, index) {
                                var elemClose = $('<i class="layui-icon" close>&#x1006;</i>');
                                layero.append(elemClose);
                                elemClose.on('click', function () { layer.close(index); });

                                admin.req({ // 形象顾问下拉选
                                    url: '/index.php/webStaff/',
                                    done: function (res) {
                                        var jsona = res.data;
                                        var listDj = $("#vip-viplist-transfer-xxgw");
                                        listDj.empty();
                                        listDj.append("<option value=''>请输入 / 选择</option>");
                                        for (var i = 0, l = jsona.length; i < l; i++) {
                                            if (jsona[i].code != 'boss') {
                                                listDj.append("<option value='" + jsona[i].code + "'class='vip_fer_staff_" + jsona[i].code + "'>" + jsona[i].name + "</option>");
                                            }
                                        }
                                        form.render(null, 'vip-viplist-transfer');
                                    }
                                });

                                admin.req({ // 门店下拉选
                                    url: '/index.php/webStore/',
                                    done: function (res) {
                                        var json = res.data;
                                        var listD = $('#vip-viplist-transfer-ssmd');
                                        listD.empty();
                                        listD.append("<option value=''>请输入 / 选择</option>");
                                        for (var i = 0, l = json.length; i < l; i++) {
                                            listD.append("<option value='" + json[i].code + "'class='vip_fer_store_" + json[i].code + "'>" + json[i].name + "</option>");
                                        }
                                        form.render(null, 'vip-viplist-transfer');
                                    }
                                });

                                $("#Confirmation_transfer").click(function () {
                                    str = '';
                                    for (var i = 0; i < num; i++) {
                                        str += table.checkStatus('vipList').data[i].id + ',';
                                    }
                                    admin.req({
                                        url: '/index.php/webVipListTransfer/',
                                        type: 'post',
                                        data: {
                                            id: str,
                                            transfer_xxgw: $("#vip-viplist-transfer-xxgw").val(),
                                            staff_name: $('.vip_fer_staff_' + $("#vip-viplist-transfer-xxgw").val()).html(),
                                            transfer_ssmd: $("#vip-viplist-transfer-ssmd").val(),
                                            store_name: $('.vip_fer_store_' + $("#vip-viplist-transfer-ssmd").val()).html()
                                        },
                                        done: function (res) {
                                            if (res.msg == 'error') {
                                                layer.msg(res.data, { icon: 2, title: '提示' });
                                            } else if (res.msg == 'yes') {
                                                layer.closeAll();
                                                layer.msg(res.data, { icon: 1, title: '提示' });
                                                viplist();
                                            } else if (res.msg == 'no') {
                                                layer.msg(res.data, { icon: 2, title: '提示' });
                                            }
                                        }
                                    });
                                    return false;
                                });
                                form.render(null, 'vip-viplist-transfer');
                            }
                        })
                    });

                    $('#crm-vip-viplist-addscreen').click(function () { // --------------------------------------------------------高级筛选
                        layer.open({
                            title: "添加高级筛选信息"
                            , type: 1
                            , shade: 0.3
                            , shadeClose: false
                            , anim: 1
                            , offset: 'auto'
                            , area: ["1000px", "500px"]
                            , skin: "layui-layer-admin layui-anim"
                            , content: '<div class="layui-form-item"><form class="layui-form" action="" lay-filter="crm-vip-viplist-screen"><div class="layui-input-inline"><select name="screen-tit" id="screen_tit" lay-filter="" lay-search=""></select></div><div class="layui-input-inline" style="width:100px;"><select name="screen-symbol" id="screen-symbol" lay-filter="" lay-search=""><option value="=">等于</option><option value="<>">不等于</option><option value=">">大于</option><option value=">=">大于等于</option><option value="<">小于</option><option value="<=">小于等于</option><option value="LIKE">包含</option></select></div><div class="layui-input-inline"><input name="screen-value" id="screen-value" autocomplete="off" class="layui-input" type="tel"></div></form><div class="layui-btn-group"><div class="layui-btn layui-btn-normal" id="crm-vip-viplist-addcondition">添加条件</div><div class="layui-btn layui-btn-normal" id="crm-vip-viplist-screen-a">筛选</div><div class="layui-btn layui-btn-normal" id="crm-vip-viplist-preservation">保存并筛选</div><div class="layui-btn layui-btn-normal" id="crm-vip-viplist-filter">筛选器</div><!--<div class="layui-btn layui-btn-normal" id="crm-vip-viplist-filter-sms">短信</div> --></div></div><!-- 表格 --><div class="layui-form-item"><table class="layui-hide" id="crm-vip-viplist-screen-t" lay-filter="cem-vip-viplist-screen-t"></table></div>'
                            , success: function (layero, index) {
                                var elemClose = $('<i class="layui-icon" close>&#x1006;</i>');
                                layero.append(elemClose);
                                elemClose.on('click', function () {
                                    layer.close(index);
                                });

                                admin.req({ // ---------------------------------------------------------------------------------清除缓存
                                    url: '/index.php/webVipdelCache/',
                                    type: 'post',
                                    done: function (res) {
                                    }
                                });

                                admin.req({ // ------------------------------------------------------------------------------------下拉选择
                                    url: '/index.php/webVipScreening/',
                                    done: function (res) {
                                        var json = res.data;
                                        var listD = $("#screen_tit");
                                        listD.empty();
                                        listD.append("<option value=''>请输入 / 选择</option>");
                                        for (var i = 0, l = json.length; i < l; i++) {
                                            listD.append("<option value='" + json[i].value + "'>" + json[i].name + "</option>");
                                        }
                                        form.render(null, 'crm-vip-viplist-screen'); // 渲染表单
                                    }
                                });

                                var initviptable = function () { // ---------------------------------------------------------------高级筛选信息列表
                                    table.render({
                                        elem: "#crm-vip-viplist-screen-t"
                                        , url: '/index.php/webVipGJlist/'
                                        , page: true
                                        , where: { access_token: layui.data(layui.setter.tableName).access_token }
                                        , cols: [[
                                            { field: 'tit', title: '标题' }
                                            , { field: 'sym', title: '条件' }
                                            , { field: 'val', title: '值', edit: 'text' }
                                            , { width: 120, title: "操作", align: "center", toolbar: "#crm-vip-viplist-screenDemo" }
                                        ]]
                                        , height: '350'
                                    });
                                }
                                initviptable();

                                table.on('edit(cem-vip-viplist-screen-t)', function (obj) { //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
                                    admin.req({
                                        url: '/index.php/webVipUpdateVlaue/',
                                        type: 'post',
                                        data: {
                                            id: obj.data.id,
                                            val: obj.value
                                        },
                                        done: function (res) {
                                            initviptable();
                                        }
                                    })
                                });

                                $("#crm-vip-viplist-addcondition").click(function () { // ------------------------------------------添加条件
                                    admin.req({
                                        url: "/index.php/webVipAddscreen/",
                                        type: "post",
                                        data: {// 给控制器传递数据
                                            tit: $("#screen_tit").val(),
                                            sym: $("#screen-symbol").val(),
                                            val: $("#screen-value").val()
                                        },
                                        done: function (res) {
                                            if (res.msg == 'yes') {
                                                initviptable();
                                                $("#screen-value").val(''); //清空值输入框内容
                                                $("#screen-value").focus(); //值输入框获取焦点
                                            } else if (res.msg == 'no') {
                                                layer.msg(res.data, { icon: 2, title: '提示' });
                                                $("#screen-value").val('');
                                                $("#screen-value").focus();
                                            }
                                        }
                                    });
                                });

                                $("#crm-vip-viplist-screen-a").click(function () { // ----------------------------------------------筛选
                                    admin.req({ // 判断添加条件是否为空
                                        url: '/index.php/webVipSeeCache/',
                                        type: 'post',
                                        done: function (res) {
                                            if (res.msg == 'yes') {
                                                viplist(true);
                                                layer.close(index);
                                            } else if (res.msg == 'no') {
                                                layer.msg(res.data, { icon: 2, title: '提示' });
                                            }
                                        }
                                    });
                                });

                                $("#crm-vip-viplist-preservation").click(function () { // ------------------------------------------保存并筛选
                                    admin.req({ //先判断添加条件是否为空
                                        url: '/index.php/webVipSeeCache/',
                                        type: 'post',
                                        done: function (res) {
                                            if (res.msg == 'yes') { // 不为空进入下一环节
                                                layer.prompt({ title: '请输入筛选标题', formType: 0 }, function (text, index) {
                                                    admin.req({
                                                        url: '/index.php/webVipFilterinfo/',
                                                        type: "post",
                                                        data: {
                                                            text: text
                                                        },
                                                        done: function (res) {
                                                            if (res.msg == 'error') {
                                                                layer.close(index);
                                                                layer.msg(res.data, { icon: 2, title: res.msg });
                                                            } else if (res.msg == 'yes') {
                                                                viplist(true); //传递筛选条件
                                                                layer.closeAll(); //关闭所有窗口
                                                                layer.msg(res.data, { icon: 1, title: '提示' });
                                                            } else if (res.msg == 'no') {
                                                                layer.msg(res.data, { icon: 2, title: '提示' });
                                                            }
                                                        }
                                                    });
                                                });
                                            } else if (res.msg == 'no') { // 为空弹出提示
                                                layer.msg(res.data, { icon: 2, title: '提示' });
                                            }
                                        }
                                    });
                                });

                                $("#crm-vip-viplist-filter").click(function () { // ------------------------------------------------筛选器
                                    layer.open({
                                        title: "筛选器"
                                        , type: 1
                                        , shade: 0.3
                                        , shadeClose: true
                                        , anim: 1
                                        , offset: 'auto'
                                        , area: ["800px", "500px"]
                                        , skin: "layui-layer-admin layui-anim"
                                        , content: '<table id="crm-vip-viplist-Filteredits" lay-filter="crm-vip-viplist-Filteredits"></table>'
                                        , success: function (layero, sindex) {
                                            var elemClose = $('<i class="layui-icon" close>&#x1006;</i>');
                                            layero.append(elemClose);
                                            elemClose.on('click', function () {
                                                layer.close(sindex);
                                            });

                                            var initvipfiltertable = function () { // ------------------------------------------------筛选器列表
                                                table.render({
                                                    elem: "#crm-vip-viplist-Filteredits"
                                                    , url: '/index.php/webVipFilterlist/'
                                                    , page: true
                                                    , where: { access_token: layui.data(layui.setter.tableName).access_token }
                                                    , cols: [[
                                                        { field: 'filtertitle', title: '筛选标题' }
                                                        , { fixed: 'right', width: 120, title: '操作', align: 'center', toolbar: '#crm-vip-viplist-Filteredit' }
                                                    ]]
                                                    , height: '350'
                                                });
                                            }
                                            initvipfiltertable();

                                            table.on('tool(crm-vip-viplist-Filteredits)', function (obj) { //------------------------监听筛选器工具条 
                                                var data = obj.data;
                                                var layEvent = obj.event;
                                                var tr = obj.tr;
                                                if (layEvent === 'crm-vip-viplist-Filterdel') { // ------------------------------------筛选器删除
                                                    layer.confirm('确认删除该条数据？', function (index) {
                                                        admin.req({
                                                            url: '/index.php/webVipFilterdel/',
                                                            type: 'post',
                                                            data: {
                                                                id: data.id
                                                            },
                                                            done: function (res) {
                                                                if (res.msg == 'error') {
                                                                    layer.msg(res.data, { icon: 2, title: res.msg });
                                                                } else if (res.msg == 'yes') {
                                                                    initvipfiltertable();
                                                                    layer.close(index);
                                                                    layer.msg(res.data, { icon: 1, title: '提示' });
                                                                } else if (res.msg == 'no') {
                                                                    layer.msg(res.data, { icon: 2, title: '提示' });
                                                                }
                                                            }
                                                        });
                                                    });
                                                } else if (layEvent === 'crm-vip-viplist-Filteredit') { // --------------------------筛选器编辑
                                                    admin.req({
                                                        url: '/index.php/webVipEitea/',
                                                        type: "post",
                                                        data: {
                                                            id: obj.data.id
                                                        }
                                                    });
                                                    initviptable();
                                                    layer.close(sindex);
                                                }
                                            });

                                            table.on('rowDouble(crm-vip-viplist-Filteredits)', function (obj) { // -------------------监听table双击获取信息
                                                tableVipList(true, obj.data.id);
                                                layer.closeAll();
                                            });
                                        }
                                    });
                                });

                                // $('#crm-vip-viplist-filter-sms').click(function () { // --------------------------------------------高级筛选短信
                                //     admin.req({ //先判断添加条件是否为空
                                //         url: '/index.php/webVipSeeCache/',
                                //         type: 'post',
                                //         done: function (res) {
                                //             if (res.msg == 'yes') {
                                //                 layer.open({
                                //                     title: "发送短信息"
                                //                     , type: 1
                                //                     , shade: 0.3
                                //                     , shadeClose: false
                                //                     , anim: 1
                                //                     , offset: 'auto'
                                //                     , area: ["650px", "300px"]
                                //                     , skin: "layui-layer-admin layui-anim"
                                //                     , content: '<form class="layui-form" action="" lay-filter="crm-vip-viplist-filter-sms"><div class="layui-form-item"><label class="layui-form-label">选择模板</label><div class="layui-input-block"><select name="sms_template" lay-filter="crm-vip-viplist-sms-template" lay-verify="required" lay-search id="crm-vip-viplist-sms-template"></select></div></div><div class="layui-form-item layui-form-text"><label class="layui-form-label">短信内容</label><div class="layui-input-block"><textarea name="smscontent" id="smscontent" class="layui-textarea" disabled></textarea></div></div><div style="text-align:center"><button class="layui-btn" lay-submit="" lay-filter="sms-submit">发送信息</button></div></form>'
                                //                     , success: function (layero, index) {
                                //                         var elemClose = $('<i class="layui-icon" close>&#x1006;</i>');
                                //                         layero.append(elemClose);
                                //                         elemClose.on('click', function () {
                                //                             layer.close(index);
                                //                         });

                                //                         admin.req({ // 循环得到短信模版下拉框
                                //                             url: '/index.php/webvipsmstemplate/',
                                //                             done: function (res) {
                                //                                 var json = res.data;
                                //                                 var listD = $("#crm-vip-viplist-sms-template");
                                //                                 listD.empty();
                                //                                 listD.append("<option value=''>请输入 / 选择</option>");
                                //                                 for (var i = 0, l = json.length; i < l; i++) {
                                //                                     listD.append("<option value='" + json[i].id + "'>" + json[i].sms_name + "</option>");
                                //                                 }
                                //                                 form.render(null, "crm-vip-viplist-filter-sms");
                                //                             }
                                //                         });

                                //                         form.on('select(crm-vip-viplist-sms-template)', function (data) { // 选择短信模版后，给短信内容赋值
                                //                             admin.req({
                                //                                 url: '/index.php/webSmscontent/',
                                //                                 type: 'post',
                                //                                 data: {
                                //                                     id: data.value
                                //                                 },
                                //                                 done: function (res) {
                                //                                     $('#smscontent').val(res.data.sms_content);
                                //                                 }
                                //                             });
                                //                         });

                                //                         form.render(null, 'crm-vip-viplist-filter-sms');

                                //                         form.on('submit(sms-submit)', function (data) { // 发送短信息
                                //                             admin.req({
                                //                                 url: '/index.php/webVipSendMessage/',
                                //                                 type: 'post',
                                //                                 data: { sms: data.field.sms_template, gj: 1 },
                                //                                 done: function (res) {
                                //                                     if (res.msg == 'error') {
                                //                                         layer.msg(res.data, { icon: 2, title: res.msg });
                                //                                     } else if (res.msg == 'yes') {
                                //                                         layer.msg(res.data, { icon: 1, title: '提示' });
                                //                                         layer.closeAll();
                                //                                         tableVipList();
                                //                                     } else if (res.msg == 'no') {
                                //                                         layer.msg(res.data, { icon: 2, title: '提示' });
                                //                                     }
                                //                                 }
                                //                             })
                                //                             return false;
                                //                         })

                                //                     }
                                //                 });
                                //             } else if (res.msg == 'no') {
                                //                 layer.msg(res.data, { icon: 2, title: '提示' });
                                //             }
                                //         }
                                //     });

                                // });

                                form.render(null, 'crm-vip-viplist-screen'); // 渲染表单

                                table.on('tool(cem-vip-viplist-screen-t)', function (obj) { //--------------------------------------监听筛选信息工具条 
                                    var data = obj.data;
                                    var layEvent = obj.event;
                                    var tr = obj.tr;
                                    if (layEvent === 'crm-vip-viplist-screendel') { // ---------------------------------------------高级筛选删除
                                        layer.confirm('确认删除该条数据？', function (delindex) {
                                            admin.req({
                                                url: '/index.php/webVipGJlistdel/',
                                                type: 'post',
                                                data: {
                                                    id: data.id
                                                },
                                                done: function (res) {
                                                    layer.close(delindex);
                                                    initviptable();
                                                }
                                            });
                                        });
                                    }
                                });
                            }
                        });
                        form.render(null, 'crm-vip-viplist-addscreen'); // 渲染表单
                    });

                    $('#viplist-batch-editing').click(function () { // ------------------------------------------------------------批量编辑
                        str = '';
                        var num = table.checkStatus('vipList').data.length;
                        if (num == 0) {
                            layer.msg('请勾选要编辑的会员', { icon: 2, title: '警告' });
                            return false;
                        }

                        for (var i = 0; i < num; i++) {
                            str += table.checkStatus('vipList').data[i].id + ',';
                        }

                        layer.open({
                            title: '批量编辑会员标签',
                            type: 1,
                            shade: 0.3,
                            shadeClose: false,
                            anim: 1,
                            area: ["1028px", "500px"],
                            skin: "layui-layer-admin layui-anim",
                            content: '<form class="layui-form layui-form-pane" action="" lay-filter="User_batch_edit"><fieldset class="layui-elem-field site-demo-button" style="margin-top:10px;padding:30px"><legend>会员标签</legend><div id="crm-vip-viplist-batch-upexit"></div></fieldset><div class="layui-form-item"><div style="text-align:center"><button class="layui-btn" id="viplist_batch_edit_extends">确认修改</button></div></div></form>',
                            success: function (layero, index) {
                                // 又上角叉号
                                var elemClose = $('<i class="layui-icon" close>&#x1006;</i>');
                                layero.append(elemClose);
                                elemClose.on('click', function () {
                                    layer.close(index);
                                })
                                form.render(null, 'User_batch_edit');  // 表单渲染

                                // 清空缓存
                                admin.req({
                                    url: '/index.php/webVipdelCache/',
                                    done: function () { }
                                });

                                // 批量编辑扩展标签的展示
                                admin.req({
                                    url: '/index.php/webVipEditExtends/',
                                    type: 'post',
                                    done: function (res) {
                                        var json = res.data.label;
                                        // 将获得到的 内容拼接成html    放入 div
                                        var allkzxx = $("#crm-vip-viplist-batch-upexit")  // 获得存放html的 div 的 id
                                        var i = 0, allkzxxinfo = "";       // 定义一个空字符串
                                        var text_arr_all = new Array(); // 文本型
                                        var date_arr_all = new Array(); // 日期型
                                        var extend_arr_all = new Array();   // 扩展型 
                                        allkzxx.empty();
                                        for (var key in json) {     // 相当于 i=0;i<json.length;i++
                                            if ((i % 3) == 0) {     // 每三个一行
                                                allkzxxinfo += '<div class="layui-form-item">';          //  拼接html的头
                                            }
                                            if (json[key]['type'] == '文本型') {
                                                allkzxxinfo += '<label class="layui-form-label">' + json[key]['name'] + '</label><div class="layui-input-inline" style="width:20%;"><input name="' + json[key].name + '" id="' + json[key].name + '" autocomplete="off" class="layui-input" type="text"></div>';
                                                text_arr_all.push({ "name": json[key]['name'] });
                                            } else if (json[key]['type'] == '扩展型') {
                                                allkzxxinfo += '<label class="layui-form-label">' + json[key]['name'] + '</label><div class="layui-input-inline" style="width:20%;"><div class="layui-btn layui-btn-primary" id="' + json[key].name + '" style="width: 190px;">请选择或添加 ' + json[key]['name'] + '</div></div>';
                                                extend_arr_all.push({ "name": json[key]['name'], "pid": json[key].code });
                                            } else if (json[key]['type'] == '日期型') {
                                                allkzxxinfo += '<label class="layui-form-label">' + json[key]['name'] + '</label><div class="layui-input-inline" style="width:20%;"><input name="' + json[key].name + '" id="' + json[key].name + '" autocomplete="off" class="layui-input" readonly="" type="text"></div>';
                                                date_arr_all.push({ "name": json[key]['name'] });
                                            }
                                            if ((i % 3) == 2) {
                                                allkzxxinfo += '</div>';             // 拼接html的尾
                                            }
                                            i++;
                                        }
                                        allkzxx.append(allkzxxinfo);

                                        // 批量编辑-------------------------------------------------------- 日期类型存入缓存
                                        var all_date_kz_cache = function (ename) {  // 接收标签的名字
                                            laydate.render({            //  -------------------------渲染日期   引入日期
                                                elem: '#' + ename,
                                                name: ename,
                                                theme: '#393D49',
                                                done: function (value, date) {      // 获取日期发送ajax  存入缓存
                                                    admin.req({
                                                        url: '/index.php/webVipAddInfoCache/',
                                                        type: 'post',
                                                        data: {
                                                            val: value,    // 传值
                                                            key: ename,     // 携带name
                                                            type: 'string'    // 类型
                                                        }
                                                    });
                                                }
                                            });
                                        }
                                        for (var d = 0; d < date_arr_all.length; d++) {
                                            all_date_kz_cache(date_arr_all[d].name);    // 循环拿到标签的名字
                                        }

                                        // 批量编辑的 文本型加入缓存
                                        for (var t = 0; t < text_arr_all.length; t++) {
                                            $('#' + text_arr_all[t].name).blur({ id: '#' + text_arr_all[t].name, name: text_arr_all[t].name }, function (dat) {
                                                admin.req({
                                                    url: '/index.php/webVipAddInfoCache/',
                                                    type: 'post',
                                                    data: {
                                                        key: dat.data.name,    //文本名字
                                                        val: $(dat.data.id).val(),  //文本内容
                                                        type: 'string'
                                                    }
                                                });
                                            });
                                        }

                                        // 批量编辑的 扩展类型的点击事件  弹出模态框 携带参数
                                        for (var e = 0; e < extend_arr_all.length; e++) {
                                            $('#' + extend_arr_all[e].name).click({ id: extend_arr_all[e].pid, name: extend_arr_all[e].name }, function (alldat) {
                                                admin.popup({
                                                    title: "请选择 [" + alldat.data.name + "]"
                                                    , shade: 0.3
                                                    , shadeClose: false
                                                    , anim: 1
                                                    , area: ["580px", "550px"]
                                                    , skin: "layui-layer-admin layui-anim"
                                                    , content: '<div class="layui-form-item"><form class="layui-form layui-form-pane" lay-filter="allzdinfo' + alldat.data.id + '"><label class="layui-form-label">' + alldat.data.name + '</label><div class="layui-input-inline"><input name="kzzdm" id="kzzdm' + alldat.data.id + '" autocomplete="off" lay-verify="required" class="layui-input" type="text"></div><button class="layui-btn layui-btn-normal layui-btn-radius" lay-submit="" lay-filter="zdinfo' + alldat.data.id + '-submit">添加' + alldat.data.name + '</button></form></div><div class="layui-form-item"><form class="layui-form layui-form-pane" lay-filter="pro-list-alledit-extends-info-demo"><ul id="zdinfobox' + alldat.data.id + '"></ul><button class="layui-btn" style="display:none" id="pro-list-alledit-extends-info-demo-submit"></button></form></div>'
                                                });
                                                form.on("submit(zdinfo" + alldat.data.id + "-submit)", function (data) {
                                                    admin.req({                                                                     //  添加标签实际内容
                                                        url: "/index.php/webVipListextendsInfo/",    // 获得表单提交的标签内容插入到数据库
                                                        type: 'post',
                                                        data: {
                                                            name: alldat.data.name,
                                                            code: alldat.data.id,
                                                            info: data.field["kzzdm"]
                                                        }, done: function (res) {
                                                            if (res.msg == 'yes') {
                                                                allextendInfoList();
                                                                layer.msg(res.data, { icon: 1, title: '提示' });
                                                            } else if (res.msg == 'no') {
                                                                layer.msg(res.data, { icon: 2, title: '提示' });
                                                            } else if (res.msg == 'error') {
                                                                layer.msg(res.data, { icon: 2, title: '提示' });
                                                            }
                                                        }
                                                    });
                                                    return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                                                });

                                                // 扩展标签的展示
                                                var allextendInfoList = function () {
                                                    admin.req({                         // 查询数据库
                                                        url: "/index.php/webVipListinfoList/",
                                                        type: 'post',
                                                        data: {
                                                            name: alldat.data.name
                                                        },
                                                        // 开始追加
                                                        done: function (res) {
                                                            $("#kzzdm" + alldat.data.id).val("");  // 清空输入框
                                                            $("#zdinfobox" + alldat.data.id).empty();
                                                            //  checkbox 底层封装 扩展标签内容的展示
                                                            checkbox({
                                                                elem: "#zdinfobox" + alldat.data.id,
                                                                nodes: res.data,
                                                                click: function (node) {
                                                                    admin.req({                                       // 点击扩展类型的内容加入缓存
                                                                        url: '/index.php/webVipAddInfoCache/',
                                                                        type: 'post',
                                                                        data: {
                                                                            type: 'array',
                                                                            key: alldat.data.name,
                                                                            val: node.name
                                                                        }
                                                                    });
                                                                },
                                                                del: function (node) {        //  删除扩展类型的内容
                                                                    admin.req({
                                                                        url: "/index.php/webVipListdelInfo/",
                                                                        type: 'post',
                                                                        data: {
                                                                            id: node.id,
                                                                        }, done: function (res) {
                                                                            if (res.msg == 'yes') {
                                                                                allextendInfoList();
                                                                                layer.msg(res.data, { icon: 1, title: '提示' });
                                                                            } else if (res.msg == 'no') {
                                                                                layer.msg(res.data, { icon: 2, title: '提示' });
                                                                            }
                                                                        }
                                                                    });
                                                                    return true;
                                                                }
                                                            });
                                                            form.render(null, "allzdinfo" + alldat.data.id);
                                                        }
                                                    })

                                                }
                                                allextendInfoList();
                                            })
                                        }
                                    }
                                })
                                // 提交批量编辑
                                $('#viplist_batch_edit_extends').click(function () {
                                    admin.req({
                                        url: '/index.php/webVipListeditSubmit/',
                                        type: 'post',
                                        data: { id: str },      // 获得全部勾选的商品的id
                                        done: function (res) {
                                            if (res.msg == 'yes') {
                                                layer.msg(res.data, { icon: 1, time: 800 }, function () {
                                                    layer.closeAll();
                                                });
                                            } else {
                                                layer.msg(res.data, { icon: 2 });
                                            }
                                        }
                                    })
                                    return false;
                                })
                            }
                        })
                    });

                }
            });


        }
        viplist();

        table.on('tool(crm-vip-viplist-list)', function (obj) { //---------------------------------------------------------监听工具条

            if (obj.event === 'crm-vip-viplist-detail') {
                layer.open({ // --------------------------------------------------------------------------------------------查看信息
                    title: '查看信息'
                    , type: 1
                    , area: ["990px", "600px"] // 弹出层的大小
                    , shadeClose: true  // 点击弹出框之外的位置关闭弹出框
                    , skin: "layui-layer-admin layui-anim"
                    , content: '<form class="layui-form layui-form-pane" action="" lay-filter="User_View"><div class="layui-form-item" style="text-align:center"><img id="viplist_img" class="layui-circle" style="width: 450px;"></div><div class="layui-form-item"><label class="layui-form-label">卡号</label><div class="layui-input-inline"><input type="text" name="card" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">姓名</label><div class="layui-input-inline"><input type="text" name="name" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">手机号码</label><div class="layui-input-inline"><input type="text" name="contact" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">性别</label><div class="layui-input-inline"><input type="text" name="sex" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">民族</label><div class="layui-input-inline"><input type="text" name="nation" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">固定电话</label><div class="layui-input-inline"><input type="text" name="telephone" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">身份证号</label><div class="layui-input-inline"><input type="text" name="identity" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">生日</label><div class="layui-input-inline"><input type="text" name="birthday" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">公历/农历</label><div class="layui-input-inline"><input type="text" name="calendar" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">所属门店</label><div class="layui-input-inline"><input type="text" name="store" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">登记店面</label><div class="layui-input-inline"><input type="text" name="register_storere" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">会员等级</label><div class="layui-input-inline"><input type="text" name="mg" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">QQ</label><div class="layui-input-inline"><input type="text" name="qq" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">入会方式</label><div class="layui-input-inline"><input type="text" name="initiation" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">形象顾问</label><div class="layui-input-inline"><input type="text" name="consultant" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">微信</label><div class="layui-input-inline"><input type="text" name="weixin" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">所属地区</label><div class="layui-input-inline"><input type="text" name="area" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">详细地址</label><div class="layui-input-inline"><input type="text" name="address" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">开卡人</label><div class="layui-input-inline"><input type="text" name="activate_bank" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">介绍人</label><div class="layui-input-inline"><input type="text" name="introducer" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">介绍人卡号</label><div class="layui-input-inline"><input type="text" name="introducer_id" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">提成人</label><div class="layui-input-inline"><input type="text" name="adult" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">有效期</label><div class="layui-input-inline"><input type="text" name="validity_term" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">售卡金额</label><div class="layui-input-inline"><input type="text" name="acs" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">支付方式</label><div class="layui-input-inline"><input type="text" name="payment_method" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">剩余总积分</label><div class="layui-input-inline"><input type="text" name="residual_integral" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">已用积分</label><div class="layui-input-inline"><input type="text" name="already_used_integral" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">剩抵现积分</label><div class="layui-input-inline"><input type="text" name="offset_integral" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">剩礼品积分</label><div class="layui-input-inline"><input type="text" name="gift_integral" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">总积分</label><div class="layui-input-inline"><input type="text" name="total_integral" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">已用储值</label><div class="layui-input-inline"><input type="text" name="stored_value" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">剩余储值</label><div class="layui-input-inline"><input type="text" name="residual_value" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">总储值</label><div class="layui-input-inline"><input type="text" name="total_value" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">总冻结储值</label><div class="layui-input-inline"><input type="text" name="total_frozen_value" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">消费次数</label><div class="layui-input-inline"><input type="text" name="consumption_times" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">消费件数</label><div class="layui-input-inline"><input type="text" name="consumption_number" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">总消费额</label><div class="layui-input-inline"><input type="text" name="total_consumption" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">首购时间</label><div class="layui-input-inline"><input type="text" name="first_time" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">最后购时间</label><div class="layui-input-inline"><input type="text" name="final_purchases" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">消费天数</label><div class="layui-input-inline"><input type="text" name="days" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">消费年数</label><div class="layui-input-inline"><input type="text" name="years" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">兑换次数</label><div class="layui-input-inline"><input type="text" name="exchange_times" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">总转介绍</label><div class="layui-input-inline"><input type="text" name="introduction" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">RFMI(总分)</label><div class="layui-input-inline"><input type="text" name="rfmi_total_score" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">R(末消费)</label><div class="layui-input-inline"><input type="text" name="r_days" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">R(类型)</label><div class="layui-input-inline"><input type="text" name="r_type" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">R(得分)</label><div class="layui-input-inline"><input type="text" name="r_score" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">F(次数)</label><div class="layui-input-inline"><input type="text" name="f_frequency" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">F(类型)</label><div class="layui-input-inline"><input type="text" name="f_type" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">F(得分)</label><div class="layui-input-inline"><input type="text" name="f_score" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">M(金额)</label><div class="layui-input-inline"><input type="text" name="m_money" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">M(类型)</label><div class="layui-input-inline"><input type="text" name="m_type" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">M(得分)</label><div class="layui-input-inline"><input type="text" name="m_score" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">I(转介绍)</label><div class="layui-input-inline"><input type="text" name="i_introduction" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">I(类型)</label><div class="layui-input-inline"><input type="text" name="i_type" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">I(得分)</label><div class="layui-input-inline"><input type="text" name="i_score" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">N(件数)</label><div class="layui-input-inline"><input type="text" name="n_number" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">N(类型)</label><div class="layui-input-inline"><input type="text" name="n_type" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">N(得分)</label><div class="layui-input-inline"><input type="text" name="n_score" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">P(客单件)</label><div class="layui-input-inline"><input type="text" name="p_univalent" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">P(类型)</label><div class="layui-input-inline"><input type="text" name="p_type" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">P(得分)</label><div class="layui-input-inline"><input type="text" name="p_score" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">A(件单价)</label><div class="layui-input-inline"><input type="text" name="a_univalent" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">A(类型)</label><div class="layui-input-inline"><input type="text" name="a_type" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">A(得分)</label><div class="layui-input-inline"><input type="text" name="a_score" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">J(连带率)</label><div class="layui-input-inline"><input type="text" name="j_related_rate" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">J(类型)</label><div class="layui-input-inline"><input type="text" name="j_type" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">J(得分)</label><div class="layui-input-inline"><input type="text" name="j_score" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">C(年消费)</label><div class="layui-input-inline"><input type="text" name="c_consumption" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">C(类型)</label><div class="layui-input-inline"><input type="text" name="c_type" autocomplete="off" class="layui-input" readonly></div><label class="layui-form-label">C(得分)</label><div class="layui-input-inline"><input type="text" name="c_score" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-form-item"><label class="layui-form-label">备注</label><div class="layui-input-block"><input type="text" name="remarks" autocomplete="off" class="layui-input" readonly></div></div><div class="layui-collapse" lay-filter="viplist_kz"><div class="layui-colla-item"><h2 class="layui-colla-title">扩展信息</h2><div id="viplist_extend_kz"></div></div></div></form>'
                    , success: function (layero, index) {
                        var elemClose = $('<i class="layui-icon" close>&#x1006;</i>');
                        layero.append(elemClose);
                        elemClose.on('click', function () {
                            layer.close(index);
                        });
                        form.render(null, 'User_View');
                        admin.req({
                            url: '/index.php/webVipckrfm/', //数据接口路由
                            data: { card: obj.data.code },
                            done: function (res) {
                                form.val("User_View", {
                                    card: obj.data.code, // 会员卡号
                                    name: obj.data.username, // 会员姓名
                                    sex: obj.data.sex, // 性别
                                    identity: obj.data.identity, // 身份证号
                                    contact: obj.data.phone, // 手机号码
                                    birthday: obj.data.birthday, // 生日
                                    telephone: obj.data.telephone, // 固定电话
                                    store: obj.data.vsname, // 所属门店
                                    register_storere: obj.data.vrname, // 登记门店
                                    nation: obj.data.nation, // 民族
                                    calendar: obj.data.calendar,  // 公历/农历
                                    initiation: obj.data.initiation,  // 入会方式
                                    mg: obj.data.vlname, // 会员等级
                                    consultant: obj.data.vgname, // 形象顾问
                                    qq: obj.data.qq, // QQ
                                    weixin: obj.data.weixin, // 微信
                                    area: obj.data.area, // 所属地区
                                    address: obj.data.address, // 详细地址
                                    activate_bank: obj.data.activate_name, // 开卡人
                                    introducer: obj.data.introducer_name, // 介绍人
                                    introducer_id: obj.data.introducer_code, // 介绍人卡号
                                    adult: obj.data.adult_code,  // 提成人
                                    acs: obj.data.acs, // 售卡金额
                                    payment_method: obj.data.payment_method, // 支付方式
                                    residual_integral: obj.data.residual_integral, // 剩余总积分
                                    already_used_integral: obj.data.already_used_integral, // 已用积分
                                    offset_integral: obj.data.offset_integral, // 剩余抵现积分
                                    gift_integral: obj.data.gift_integral, // 剩余礼品积分
                                    total_integral: obj.data.total_integral, // 总积分
                                    stored_value: obj.data.stored_value, // 已用储值
                                    residual_value: obj.data.residual_value, // 剩余储值
                                    total_value: obj.data.total_value, // 总储值
                                    total_frozen_value: obj.data.total_frozen_value, // 总冻结储值
                                    consumption_times: obj.data.consumption_times, // 消费次数
                                    consumption_number: obj.data.consumption_number, // 消费件数
                                    total_consumption: obj.data.total_consumption, // 总消费额
                                    first_time: obj.data.first_time, // 首次购物时间
                                    final_purchases: obj.data.final_purchases, // 最后购物时间
                                    exchange_times: obj.data.exchange_number, // 兑换次数
                                    remarks: obj.data.remarks, // 备注

                                    days: obj.data.days, // 消费天数
                                    years: obj.data.years, // 消费年数
                                    introduction: res.data.introduction, // 总转介绍树
                                    rfmi_total_score: res.data.rfm, // RMF总得分
                                    r_days: obj.data.r_days,
                                    r_type: res.data.r_type,
                                    r_score: res.data.r_score,
                                    f_frequency: res.data.f_frequency,
                                    f_type: res.data.f_type,
                                    f_score: res.data.f_score,
                                    m_money: res.data.m_money,
                                    m_type: res.data.m_type,
                                    m_score: res.data.m_score,
                                    i_introduction: res.data.i_introduction,
                                    i_type: res.data.i_type,
                                    i_score: res.data.i_score,
                                    n_number: res.data.n_number,
                                    n_type: res.data.n_type,
                                    n_score: res.data.n_score,
                                    p_univalent: res.data.p_univalent,
                                    p_type: res.data.p_type,
                                    p_score: res.data.p_score,
                                    a_univalent: res.data.a_univalent,
                                    a_type: res.data.a_type,
                                    a_score: res.data.a_score,
                                    j_related_rate: res.data.j_related_rate,
                                    j_type: res.data.j_type,
                                    j_score: res.data.j_score,
                                    c_consumption: res.data.c_consumption,
                                    c_type: res.data.c_type,
                                    c_score: res.data.c_score,
                                });
                            }
                        });

                        $("#viplist_img").attr("src", obj.data.img);
                        viplist_extend(obj.data.code);
                    }
                });
            } else if (obj.event === 'crm-vip-viplist-edit') { //-----------------------------------------------------------编辑信息
                layer.open({
                    title: "编辑会员标签",
                    type: 1,
                    shade: 0.3,
                    shadeClose: true,
                    anim: 1,
                    area: ["1030px", "500px"],
                    skin: "layui-layer-admin layui-anim",
                    content: '<form class="layui-form layui-form-pane" action="" lay-filter="User_edit"><fieldset class="layui-elem-field site-demo-button" style="margin-top:10px; padding: 30px;"><legend>会员标签</legend><div id="crm-vip-viplist-upexit"></div></fieldset><div class="layui-form-item"><div style="text-align:center"><button class="layui-btn" id="viplist_edit_extends">确认修改</button></div></div></form>',
                    success: function (layero, index) {
                        // 右上角叉号
                        var elemClose = $('<i class="layui-icon" close>&#x1006;</i>');
                        layero.append(elemClose);
                        elemClose.on('click', function () { layer.close(index); });

                        vip_edit_kz(obj.data.id, $("#crm-vip-viplist-upexit"));

                        $('#viplist_edit_extends').click(function () {
                            admin.req({
                                url: '/index.php/webVipListeditSubmit/',
                                type: 'post',
                                data: { id: obj.data.id },
                                done: function (res) {
                                    if (res.msg == 'yes') {
                                        layer.msg(res.data, { icon: 1, time: 800 }, function () {
                                            layer.closeAll();
                                        });
                                    } else {
                                        layer.msg(res.data, { icon: 2 });
                                    }
                                }
                            })
                            return false;
                        });
                    }
                });
            }
        });

        var vip_edit_kz = function (id, htm) { // -------------------------------------------------------------------------扩展信息调用的方法
            admin.req({
                url: 'index.php/webVipEditExtends/',
                type: 'post',
                data: { id: id },
                done: function (res) {
                    var ext = res.data.extension;
                    var json = res.data.label;
                    // 将获得到的 内容拼接成html    放入 div
                    var kzxx = htm // 获得存放html的 div 的 id
                    var i = 0, kzxxinfo = "";       // 定义一个空字符串
                    var text_arr = new Array(); // 文本型
                    var date_arr = new Array(); // 日期型
                    var extend_arr = new Array();   // 扩展型 
                    kzxx.empty();
                    for (var key in json) {     // 相当于 i=0;i<json.length;i++
                        if ((i % 3) == 0) {     // 每三个一行
                            kzxxinfo += '<div class="layui-form-item">';          //  拼接html的头
                        }
                        if (json[key]['type'] == '文本型') {
                            kzxxinfo += '<label class="layui-form-label">' + json[key]['name'] + '</label><div class="layui-input-inline" style="width:20%;"><input name="' + json[key].name + '" id="' + json[key].name + '" autocomplete="off" class="layui-input" type="text"></div>';
                            text_arr.push({ "name": json[key]['name'] });
                        } else if (json[key]['type'] == '扩展型') {
                            kzxxinfo += '<label class="layui-form-label">' + json[key]['name'] + '</label><div class="layui-input-inline" style="width:20%;"><div class="layui-btn layui-btn-primary" id="' + json[key].name + '" style="width: 190px;">请选择或添加 ' + json[key]['name'] + '</div></div>';
                            extend_arr.push({ "name": json[key]['name'], "pid": json[key].code });
                        } else if (json[key]['type'] == '日期型') {
                            kzxxinfo += '<label class="layui-form-label">' + json[key]['name'] + '</label><div class="layui-input-inline" style="width:20%;"><input name="' + json[key].name + '" id="' + json[key].name + '" autocomplete="off" class="layui-input" readonly="" type="text"></div>';
                            date_arr.push({ "name": json[key]['name'] });
                        }
                        if ((i % 3) == 2) {
                            kzxxinfo += '</div>';             // 拼接html的尾
                        }
                        i++;
                    }
                    kzxx.append(kzxxinfo);

                    // -------------------------------------------------------- 日期类型存入缓存
                    var date_kz_cache = function (ename) {  // 接收标签的名字
                        laydate.render({            //  -------------------------渲染日期   引入日期
                            elem: '#' + ename,
                            name: ename,
                            theme: '#393D49',
                            done: function (value, date) {      // 获取日期发送ajax  存入缓存
                                admin.req({
                                    url: '/index.php/webVipAddInfoCache/',
                                    type: 'post',
                                    data: {
                                        val: value,    // 传值
                                        key: ename,     // 携带name
                                        type: 'string'    // 类型
                                    }
                                });
                            }
                        });
                    }
                    for (var d = 0; d < date_arr.length; d++) {
                        date_kz_cache(date_arr[d].name);    // 循环拿到标签的名字
                    }

                    // 文本型加入缓存
                    for (var t = 0; t < text_arr.length; t++) {
                        $('#' + text_arr[t].name).blur({ id: '#' + text_arr[t].name, name: text_arr[t].name }, function (dat) {
                            admin.req({
                                url: '/index.php/webVipAddInfoCache/',
                                type: 'post',
                                data: {
                                    key: dat.data.name,    //文本名字
                                    val: $(dat.data.id).val(),  //文本内容
                                    type: 'string'
                                }
                            });
                        });
                    }

                    // 文本 日期类型赋初始值
                    if (ext != '') {
                        for (var key in json) {
                            if (json[key].type == '日期型' || json[key].type == '文本型')
                                $("#" + json[key].name).val(ext[json[key].name]);
                        }
                    }
                    // 扩展类型的点击事件  弹出模态框 携带参数
                    for (var e = 0; e < extend_arr.length; e++) {
                        $('#' + extend_arr[e].name).click({ id: extend_arr[e].pid, name: extend_arr[e].name }, function (dat) {
                            admin.popup({
                                title: "请选择 [" + dat.data.name + "]"
                                , shade: 0.3
                                , shadeClose: false
                                , anim: 1
                                , area: ["580px", "550px"]
                                , skin: "layui-layer-admin layui-anim"
                                , content: '<div class="layui-form-item"><form class="layui-form layui-form-pane" lay-filter="zdinfo' + dat.data.id + '"><label class="layui-form-label">' + dat.data.name + '</label><div class="layui-input-inline"><input name="kzzdm" id="kzzdm' + dat.data.id + '" autocomplete="off" lay-verify="required" class="layui-input" type="text"></div><button class="layui-btn layui-btn-normal layui-btn-radius" lay-submit="" lay-filter="zdinfo' + dat.data.id + '-submit">添加' + dat.data.name + '</button></form></div><div class="layui-form-item"><form class="layui-form layui-form-pane" lay-filter="crm-set-commodity-kzzdinfo"><ul id="zdinfobox' + dat.data.id + '"></ul><button class="layui-btn" style="display:none" lay-submit="" lay-filter="crm-set-commodity-kzzdinfo-submit" id="crm-set-commodity-kzzdinfo-submit"></button></form></div>'
                            });
                            // 监听表单  button    lay-filter="zdinfo' + dat.data.id + '-submit"
                            form.on("submit(zdinfo" + dat.data.id + "-submit)", function (data) {

                                admin.req({                                                                     //  添加标签实际内容
                                    url: "/index.php/webVipListextendsInfo/",    // 获得表单提交的标签内容插入到数据库
                                    type: 'post',
                                    data: {
                                        name: dat.data.name,
                                        code: dat.data.id,
                                        info: data.field["kzzdm"]
                                    }, done: function (res) {
                                        if (res.msg == 'yes') {
                                            extendInfoList();
                                            layer.msg(res.data, { icon: 1, title: '提示' });
                                        } else if (res.msg == 'no') {
                                            layer.msg(res.data, { icon: 2, title: '提示' });
                                        } else if (res.msg == 'error') {
                                            layer.msg(res.data, { icon: 2, title: '提示' });
                                        }
                                    }
                                });
                                return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                            });

                            // 扩展标签的展示
                            var extendInfoList = function () {
                                admin.req({                         // 查询数据库
                                    url: "/index.php/webVipListinfoList/",
                                    type: 'post',
                                    data: {
                                        name: dat.data.name
                                    },
                                    // 开始追加
                                    done: function (res) {
                                        $("#kzzdm" + dat.data.id).val("");  // 清空输入框
                                        $("#zdinfobox" + dat.data.id).empty();
                                        //  checkbox 底层封装 扩展标签内容的展示
                                        checkbox({
                                            elem: "#zdinfobox" + dat.data.id,
                                            nodes: res.data,
                                            click: function (node) {
                                                admin.req({                                       // 点击扩展类型的内容加入缓存
                                                    url: '/index.php/webVipAddInfoCache/',
                                                    type: 'post',
                                                    data: {
                                                        type: 'array',
                                                        key: dat.data.name,
                                                        val: node.name
                                                    }
                                                });
                                            },
                                            del: function (node) {        //  删除扩展类型的内容
                                                admin.req({
                                                    url: "/index.php/webVipListdelInfo/",
                                                    type: 'post',
                                                    data: {
                                                        id: node.id,
                                                    }, done: function (res) {
                                                        if (res.msg == 'yes') {
                                                            extendInfoList();
                                                            layer.msg(res.data, { icon: 1, title: '提示' });
                                                        } else if (res.msg == 'no') {
                                                            layer.msg(res.data, { icon: 2, title: '提示' });
                                                        }
                                                    }
                                                });
                                                return true;
                                            }
                                        });
                                        form.render(null, "zdinfo" + dat.data.id);
                                    }
                                })

                            }
                            extendInfoList();

                        })
                    }

                }
            })
        }

        var viplist_extend = function (id) {  // --------------------------------------------------------------------------查看中扩展信息调用的方法
            admin.req({
                url: '/index.php/webVipGetlistkzval/'
                , data: {
                    id: id
                }, done: function (r) {
                    $('#viplist_extend_kz').empty();
                    var rd = r.data, rl = r.data.length, fstr = '';
                    for (var i = 0; i < rl; i++) {
                        fstr += '<div class="layui-form-item">' +
                            '<label class="layui-form-label"> ' + rd[i].key + '</label >' +
                            '<div class="layui-input-block">' +
                            '<input type="text" value="' + rd[i].val + '" autocomplete="off" class="layui-input" disabled>' +
                            '</div>' +
                            '</div>';
                    }
                    $('#viplist_extend_kz').html(fstr);
                }
            });
            return false;
        }

    });
</script>
<script type="text/html" id="crm-vip-viplist-barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="crm-vip-viplist-detail">查看</a>
        <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="crm-vip-viplist-edit">会员标签</a>
</script>
<script type="text/html" id="crm-vip-viplist-screenDemo">
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="crm-vip-viplist-screendel">删除</a>
</script>
<script type="text/html" id="crm-vip-viplist-Filteredit">
    <a class="layui-btn layui-btn-xs" lay-event="crm-vip-viplist-Filteredit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="crm-vip-viplist-Filterdel">删除</a>
</script>