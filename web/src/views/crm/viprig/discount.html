<title>感动特权</title>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-body">
                    <div class="layui-collapse">
                        <div class="layui-colla-item">
                            <table class="layui-hide" id="crm-vip-viprights-discount" lay-filter="crm-vip-viprights-discount"></table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/html" id="crm-vip-viprig-dis-toolbar">
    <div class="layui-btn-container">
      <button class="layui-btn layui-btn-sm" lay-event="add">添加</button>
      <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="search">查找</button>
      <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="del">删除</button>
    </div>
</script>
<script type="text/html" id="crm-vip-dis-barDemo">
    <!-- <a class="layui-btn layui-btn-xs" lay-event="crm-vip-viprights-show">消费项目</a> -->
    <a class="layui-btn layui-btn-xs" lay-event="crm-vip-viprights-edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="crm-vip-viprights-del">删除</a>
</script>
<!-- 选择优惠项目商品头工具栏按钮 -->
<script type="text/html" id="crm-vip-viprig-dis-type-goods-toolbar">
    <div class="layui-btn-container">
      <button class="layui-btn layui-btn-sm" lay-event="add">添加</button>
      <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="sea">查询</button>
    </div>
</script>
<!-- 消费项目查看头 -->
<script type="text/html" id="crm-vip-viprig-dis-show-toolbar">
    <div class="layui-btn-container">
      <button class="layui-btn layui-btn-sm" lay-event="edit">修改</button>
    </div>
</script>
<script>
    layui.use(['admin', 'table', 'form', 'tree', 'checkbox'], function () {
        var $ = layui.$
            , admin = layui.admin
            , element = layui.element
            , table = layui.table
            , form = layui.form
            , checkbox = layui.checkbox
            , router = layui.router()
            , tree = layui.tree;

        //会员服务
        var discount = function (discountUrl) {
            table.render({
                elem: '#crm-vip-viprights-discount'
                , height: 'full-150'
                , url: discountUrl
                , page: true //开启分页
                , limit: 20
                , limits: [20, 50, 100, 200, 500]
                , where: {
                    access_token: layui.data(layui.setter.tableName).access_token
                }
                , cols: [[ //表头
                    { type: 'checkbox', fixed: 'left' }
                    , { field: 'username', width: 278, title: '规则名称', align: 'center' }
                    , { field: 'vpname', width: 160, title: '所属店面', align: 'center' }
                    , { field: 'vgname', width: 160, title: '会员级别', align: 'center', sort: true }
                    , { field: 'exclusive_code', width: 160, title: '专属名称', align: 'center' }
                    , { field: 'limited_time', minwidth: 230, title: '限定时间', align: 'center' }
                    , { field: 'exclusive_discounts', width: 120, title: '专属折扣', align: 'center', sort: true }
                    // , { field: 'integral_multiple', width: 120, title: '积分倍数', align: 'center', sort: true }
                    , { fixed: 'right', width: 200, title: '操作', align: 'center', toolbar: '#crm-vip-dis-barDemo' }
                ]]
                , toolbar: '#crm-vip-viprig-dis-toolbar'
            });
        }
        discount('/index.php/webDiscountlist/');

        //获取所属类别列表
        var initcategoryTree = function (d) {
            admin.req({
                url: "/index.php/webTableTree/"
                , done: function (res) {//res.data
                    tree({
                        elem: d
                        , nodes: res.data
                        , click: function (node) {
                            layer.open({
                                title: '选择商品（友情提示：每个活动只能选择同类别下的商品，类别不限于哪一级。注意：第二次选择会覆盖第一次选择的商品）',
                                type: 1,
                                shade: 0.3,
                                shadeClose: false,
                                anim: 1,
                                offset: 'auto',
                                area: ['1000px', '500px'],
                                skin: "layui-layer-admin layui-anim",
                                content: '<table class="layui-hide" id="crm-vip-viprights-discount-add-type-goods" lay-filter="crm-vip-viprights-discount-add-type-goods"></table>',
                                success: function (listLayero, listIndex) {
                                    var elem2Close = $('<i class="layui-icon" close>&#x1006;</i>');
                                    listLayero.append(elem2Close);
                                    elem2Close.on('click', function () {
                                        layer.close(listIndex);
                                    });

                                    // 列表请求
                                    var type_goods_check_list = function (wh = '') {
                                        table.render({
                                            elem: '#crm-vip-viprights-discount-add-type-goods'
                                            , height: 390
                                            , url: '/index.php/webGetGoods/'
                                            , where: { code: node.code, path: node.path, access_token: layui.data(layui.setter.tableName).access_token, wh: wh }
                                            , cols: [[ //表头
                                                { type: 'checkbox', fixed: 'left' },
                                                { field: 'bar_code', width: 200, title: '条码', align: 'center' },
                                                { field: 'frenum', minwidth: 120, title: '货号', align: 'center' },
                                                { field: 'name', minwidth: 120, title: '商品名', align: 'center' },
                                                { field: 'unit_name', width: 60, title: '单位', align: 'center' },
                                                { field: 'color', width: 70, title: '颜色', align: 'center' },
                                                { field: 'size', width: 70, title: '尺码', align: 'center' },
                                                { field: 'price', width: 100, title: '价格', align: 'center' }
                                            ]]
                                            , toolbar: '#crm-vip-viprig-dis-type-goods-toolbar'
                                        });
                                    }
                                    type_goods_check_list();
                                    table.on('toolbar(crm-vip-viprights-discount-add-type-goods)', function (objDisGoods) {
                                        var checkStatus = table.checkStatus(objDisGoods.config.id);
                                        var listWhere = objDisGoods.config.where.where;
                                        switch (objDisGoods.event) {
                                            case 'add':
                                                var checkNum = checkStatus.data.length;
                                                if (checkNum < 1) {
                                                    layer.msg('请选择至少一款商品', { icon: 2, title: '提示' });
                                                    return false;
                                                }
                                                var goods = '';
                                                if (checkStatus.isAll == true && typeof(listWhere) == 'undefined') {
                                                    // 分类的ID
                                                    goods = node.code;
                                                    var type = 0;
                                                } else {
                                                    for (var i = 0; i < checkNum; i++) {
                                                        goods += checkStatus.data[i].code + ',';
                                                    }
                                                    var type = 1;
                                                }
                                                admin.req({
                                                    url: '/index.php/webCacheGoods/',
                                                    type: 'post',
                                                    data: { goods: goods, type: type },
                                                    done: function (res) {
                                                        if (res.msg == 'error') {
                                                            layer.msg(res.data, { icon: 2 });
                                                        } else if (res.msg == 'yes') {
                                                            layer.close(listIndex);
                                                            layer.msg(res.data, { icon: 1 });
                                                        } else if (res.msg == 'no') {
                                                            layer.msg(res.data, { icon: 2 });
                                                        }
                                                    }
                                                });
                                                return false;
                                                break;
                                            case 'sea':

                                                layer.prompt({ title: '可以按(商品名,条码,货号,单位,颜色,尺码,价格)查询', formType: 0 }, function (text, index) {
                                                    type_goods_check_list(text);
                                                    layer.close(index);
                                                    return false;
                                                });
                                                break;
                                        };
                                    })
                                }
                            });
                        }
                    });
                }
            });
        //--------------------------------------------------------------------编辑的所属类别点击事件
            $(".downpanel").on("click", ".layui-select-title", function (e) {
                $(".layui-form-select").not($(this).parents(".layui-form-select")).removeClass("layui-form-selected");
                $(this).parents(".downpanel").toggleClass("layui-form-selected");
                layui.stope(e);
            }).on("click", "dl i", function (e) {
                layui.stope(e);
            });
        };
        

        // 表头按钮事件监听
        table.on('toolbar(crm-vip-viprights-discount)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id);
            switch (obj.event) {
                case 'add':
                    layer.open({
                        title: "添加信息"
                        , type: 1
                        , shade: 0.3
                        , shadeClose: false
                        , anim: 1
                        , offset: 'auto'
                        , area: ["1100px", "350px"]
                        , skin: "layui-layer-admin layui-anim"
                        , content: '<form class="layui-form" action="" lay-filter="crm-vip-viprights-discount"><div class="layui-form-item"><div class="layui-inline"><label class="layui-form-label">规则名称</label><div class="layui-input-inline"><input type="text" name="username" id="dis_add" autocomplete="off" lay-verify="required" class="layui-input"></div></div><div class="layui-inline"><label class="layui-form-label">所属店面</label><div class="layui-input-inline"><div class="layui-btn layui-btn-normal" id="add_ssmd">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;添&nbsp;&nbsp;加&nbsp;&nbsp;门&nbsp;&nbsp;店&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></div></div><div class="layui-inline"><label class="layui-form-label">会员级别</label><div class="layui-input-inline"><select name="level" id="crm-vip-discount-hydj" lay-verify="required" lay-search></select></div></div></div><div class="layui-form-item"><div class="layui-inline"><label class="layui-form-label">消费项目</label><div class="layui-input-inline"><div class="layui-unselect layui-form-select downpanel"><div class="layui-select-title" id="crm_viprig_dis_add_type_select"><span class="layui-input layui-unselect" style="line-height:35px">商品类别</span> <input type="hidden" name="splb"> <i class="layui-edge"></i></div><dl class="layui-layer-admin layui-anim"><dd><ul id="crm-vip-viprig-dis-classtree_add"></ul></dd></dl></div></div></div><div class="layui-inline"><label class="layui-form-label">专属折扣</label><div class="layui-input-inline"><input type="text" name="exclusive_discounts" autocomplete="off" class="layui-input"></div><div class="layui-form-mid layui-word-aux">例如:0.95</div></div></div><div class="layui-form-item"><div class="layui-inline"><label class="layui-form-label">专属名称</label><div class="layui-input-inline"><select lay-filter="aihao" name="exclusive_days" id="crm-viprig-dis-add-excdays"></select></div><label class="layui-form-mid">前</label><div class="layui-input-inline"><input type="text" name="limited_time_start" autocomplete="off" class="layui-input"></div><label class="layui-form-mid">天 至 后</label><div class="layui-input-inline"><input type="text" name="limited_time_end" autocomplete="off" class="layui-input"></div><label class="layui-form-mid">天</label></div></div><div class="layui-form-item"><div style="text-align:center"><button class="layui-btn layui-btn-radius" lay-submit lay-filter="crm-vip-viprights-discountSub">确定添加</button></div></div></form>'
                        , success: function (layero, index) {
                            var elemClose = $('<i class="layui-icon" close>&#x1006;</i>');
                            layero.append(elemClose);
                            elemClose.on('click', function () {
                                layer.close(index);
                            });
                            $("#dis_add").focus();

                            admin.req({ // ---------------------------------------------------------------------------------------------清除缓存
                                url: '/index.php/websetCacheNull/',
                                type: 'post',
                                done: function (res) {
                                }
                            });

                            $("#add_ssmd").click(function () {
                                layer.open({
                                    title: "添加所属店面"
                                    , type: 1
                                    , shade: 0.3
                                    , shadeClose: false
                                    , anim: 1
                                    , offset: 'auto'
                                    , area: ["465px", "300px"]
                                    , skin: "layui-layer-admin layui-anim"
                                    , content: '<div class="layui-form-item"><form class="layui-form layui-form-pane" action="" lay-filter="crm-viprig-discount-ssmd"><label class="layui-form-label">所属店面：</label><div class="layui-input-inline"><select name="ssmd_name" id="ssmd_name" lay-filter="aihao lay-search" lay-search lay-verify="required" lay-search></select></div><label class="layui-form-mid"></label><div class="layui-input-inline" style="width:50px"><button class="layui-btn" lay-submit="" lay-filter="crm_viprig_discount_add_normal">添加</button></div></form></div><div class="layui-form-item"><ul id="crm-viprig-discount-add-ul"></ul></div>'
                                    , success: function (layero, index) {
                                        var elemClose = $('<i class="layui-icon" close>&#x1006;</i>');
                                        layero.append(elemClose);
                                        elemClose.on('click', function () {
                                            layer.close(index);
                                        });

                                        admin.req({ // ---------------------------------------------------------------------------------------------循环得到所属门店下拉表信息
                                            url: "/index.php/websetDisstore/",
                                            done: function (res) {
                                                var jsona = res.data;
                                                var listDj = $('#ssmd_name');
                                                listDj.empty();
                                                listDj.append("<option value=''>请输入 / 选择</option>");
                                                for (var i = 0, l = jsona.length; i < l; i++) {
                                                    listDj.append("<option value='" + jsona[i].code + "' id='discount-fuxiao-add-" + jsona[i].code + "'>" + jsona[i].name + "</option>");
                                                }
                                                form.render(null, "crm-viprig-discount-ssmd");
                                            }
                                        });

                                        form.on("submit(crm_viprig_discount_add_normal)", function (date) { // -----------------------------------------------监听执行添加
                                            admin.req({
                                                url: "/index.php/webgetBelongedAdd/",
                                                type: "post",
                                                data: {// 给控制器传递数据
                                                    ssmd_name: date.field.ssmd_name, //所属门店
                                                    name: $('#discount-fuxiao-add-' + date.field.ssmd_name).text()
                                                }, done: function (res) {
                                                    if (res.msg == 'error') {
                                                        layer.msg(res.data, { icon: 2 });
                                                    } else if (res.msg == 'yes') {
                                                        discountinfo();
                                                    } else if (res.msg == 'no') {
                                                        layer.msg(res.data, { icon: 2 });
                                                    }
                                                }
                                            });
                                            return false;
                                        });
                                        form.render(null, "crm-viprig-discount-ssmd");

                                        var discountinfo = function () {
                                            admin.req({
                                                url: "/index.php/webgetDcacheAdd/"
                                                , done: function (res) {
                                                    $("#crm-viprig-discount-add-ul").empty();
                                                    checkbox({
                                                        elem: "#crm-viprig-discount-add-ul"
                                                        , nodes: res.data
                                                        , del: function (node) {
                                                            admin.req({ // 删除扩展信息
                                                                url: "/index.php/webgetDiscacheDel/"
                                                                , data: {
                                                                    id: node.id
                                                                }, done: function (res) {
                                                                    if (res.msg == 'yes') {
                                                                        discountinfo();
                                                                    } else {
                                                                        layer.msg(res.msg, { icon: 2 });
                                                                    }
                                                                }
                                                            });
                                                            return true;
                                                        }
                                                    });
                                                    form.render(null, "crm-viprig-discount-ssmd");
                                                }
                                            });
                                        };
                                        discountinfo();
                                    }
                                });
                            });

                            initList2('/index.php/webgeTzsdis/','#crm-viprig-dis-add-excdays');
                            initList("/index.php/webDroplevel/", "#crm-vip-discount-hydj");
                            initList1("/index.php/webStores/", "#crm-vip-discount-ssdm");
                            form.render(null, 'crm-vip-viprights-discount');

                            //获取所属类别列表
                            initcategoryTree("#crm-vip-viprig-dis-classtree_add");
                            
                            // 表单提交事件
                            form.on("submit(crm-vip-viprights-discountSub)", function (data) {
                                var reg = /^(1|0(\.\d{1,2})?)$/;
                                var regs = /(^[1-9]([0-9]+)?(\.[0-9]{1,2})?$)|(^(0){1}$)|(^[0-9]\.[0-9]([0-9])?$)/;
                                var tmsg = '积分倍数格式错误';
                                if (data.field.integral_multiple != '') {
                                    if (!regs.test(data.field.integral_multiple)) {   // js正则验证  消费总金额
                                        layer.msg(tmsg, { icon: 2 });
                                        return false;
                                    }
                                }
                                if (!reg.test(data.field.exclusive_discounts)) {
                                    layer.msg('专属折扣必须是0-1之间的两位小数', { icon: 2, title: '提示' });
                                    return false;
                                }
                                admin.req({
                                    url: "/index.php/webDiscountAdd/",
                                    type: "post",
                                    data: {
                                        username: $.trim(data.field.username), //规则名称
                                        // storefront: data.field.storefront, //所属店面
                                        level: data.field.level, //会员级别
                                        // project: data.field.project, //消费项目
                                        exclusive_days: $.trim(data.field.exclusive_days), //专属名称
                                        limited_time_start: $.trim(data.field.limited_time_start), //专属名称 开始
                                        limited_time_end: $.trim(data.field.limited_time_end), //专属名称 结束
                                        exclusive_discounts: $.trim(data.field.exclusive_discounts), //专属折扣
                                        // integral_multiple: $.trim(data.field.integral_multiple), //积分倍数
                                    },
                                    done: function (res) {
                                        if (res.msg == 'error') {
                                            layer.msg(res.data, { icon: 2, title: res.msg });
                                        } else if (res.msg == 'yes') {
                                            layer.close(index);
                                            discount('/index.php/webDiscountlist/');
                                            layer.msg(res.data, { icon: 1, title: '提示' });
                                        } else if (res.msg == 'no') {
                                            layer.msg(res.data, { icon: 2, title: '提示' });
                                        }
                                    }
                                });
                                return false;
                            });
                        }
                    });

                    break;
                case 'search':
                    layer.prompt({ title: '查找（按照 规则名称 / 所属店面 / 会员级别）', formType: 0 }, function (text, index) {
                        layer.close(index);
                        discount('/index.php/webDiscountlist/?discountlookup=' + text);
                        return false;
                    });
                    break;
                case 'del':
                    if (checkStatus.data.length < 1) {
                        layer.msg('请选择至少一条数据', { icon: 2, title: '提示' });
                        return false;
                    }
                    var ids = '';
                    for (var i = 0; i < checkStatus.data.length; i++) {
                        ids += checkStatus.data[i].id + ',';
                    }
                    layer.confirm('确认删除？', { icon: 3, title: '提示' }, function (index) {
                        crmVipDisDel(ids);
                    })
                    break;
            };
        });

        // 批量删除
        var crmVipDisDel = function (ids) {
            admin.req({
                url: '/index.php/webDiscountdelMany/',
                type: 'post',
                data: { ids: ids },
                done: function (res) {
                    if (res.msg == 'error') {
                        layer.msg(res.data, { icon: 2, title: '警告' });
                    } else if (res.msg == 'yes') {
                        layer.close(layer.index);
                        discount('/index.php/webDiscountlist/');
                        layer.msg(res.data, { icon: 1, title: '提示' });
                    } else if (res.msg == 'no') {
                        layer.msg(res.data, { icon: 2, title: '提示' });
                    }
                }
            });
            return false;
        }

        // 获取专属名称值
        var initList2 = function (u, d, value) {
            admin.req({
                url: u,
                done: function (res) {
                    var json = res.data;
                    var listD = $(d);
                    listD.empty();
                    listD.append("<option value=''>请输入 / 选择</option>");
                    for (var i = 0, l = json.length; i < l; i++) {
                        listD.append("<option value='" + json[i].code + "'>" + json[i].relation + "</option>");
                    }
                    $(d).val(value);
                    form.render(null, "crm-vip-viprights-discount");
                    form.render(null, 'crm-vip-viprights-discount-edit');
                }
            });
        }


        //循环得到会员等级下拉框信息
        var initList = function (u, d, value) {
            admin.req({
                url: u,
                done: function (res) {
                    var json = res.data;
                    var listD = $(d);
                    listD.empty();
                    listD.append("<option value=''>请输入 / 选择</option>");
                    for (var i = 0, l = json.length; i < l; i++) {
                        listD.append("<option value='" + json[i].code + "'>" + json[i].username + "</option>");
                    }
                    $(d).val(value);
                    form.render(null, "crm-vip-viprights-discount");
                    form.render(null, 'crm-vip-viprights-discount-edit');
                }
            });
        }

        var initList1 = function (u, d, value) {
            admin.req({
                url: u,
                done: function (res) {
                    var json = res.data;
                    var listD = $(d);
                    listD.empty();
                    listD.append("<option value=''>请输入 / 选择</option>");
                    for (var i = 0, l = json.length; i < l; i++) {
                        listD.append("<option value='" + json[i].code + "'>" + json[i].name + "</option>");
                    }
                    $(d).val(value);
                    form.render(null, "crm-vip-viprights-discount");
                    form.render(null, 'crm-vip-viprights-discount-edit');
                }
            });
        }

        //监听工具条
        table.on('tool(crm-vip-viprights-discount)', function (obj) {
            var data = obj.data;
            if (obj.event === 'crm-vip-viprights-del') {
                layer.confirm('确定要删除这条信息么?', function (index) {
                    admin.req({
                        url: "/index.php/webDiscountdel/",
                        type: "post",
                        data: {
                            id: obj.data.id
                        },
                        done: function (res) {
                            if (res.msg == 'error') {
                                layer.msg(res.data, { icon: 2, title: res.msg });
                            } else if (res.msg == 'yes') {
                                obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                                layer.close(index);
                                discount('/index.php/webDiscountlist/');
                                layer.msg(res.data, { icon: 1, title: '提示' });
                            } else if (res.msg == 'no') {
                                layer.msg(res.data, { icon: 2, title: '提示' });
                            }
                        }
                    });
                });
            } else if (obj.event === 'crm-vip-viprights-edit') {
                layer.open({
                    title: "编辑信息",
                    type: 1,
                    shade: 0.3,
                    shadeClose: false,
                    anim: 1,
                    area: ["1100px", "350px"],
                    skin: "layui-layer-admin layui-anim",
                    content: '<form class="layui-form" action="" lay-filter="crm-vip-viprights-discount-edit"><div class="layui-form-item"><div class="layui-inline"><label class="layui-form-label">规则名称</label><div class="layui-input-inline"><input type="text" name="username" autocomplete="off" lay-verify="required" class="layui-input"></div></div><div class="layui-inline"><label class="layui-form-label">所属店面</label><div class="layui-input-inline"><select name="storefront" id="crm-vip-discount-ssdm-edit" lay-search></select></div></div><div class="layui-inline"><label class="layui-form-label">会员级别</label><div class="layui-input-inline"><select name="level" id="crm-vip-discount-hydj-edit" lay-verify="required" lay-search></select></div></div></div><div class="layui-form-item"><div class="layui-inline"><label class="layui-form-label">消费项目</label><div class="layui-input-inline"><div class="layui-unselect layui-form-select downpanel"><div class="layui-select-title" id="crm_viprig_dis_add_type_select-edit"><span class="layui-input layui-unselect" style="line-height:35px">商品类别</span> <input type="hidden" name="splb"> <i class="layui-edge"></i></div><dl class="layui-layer-admin layui-anim"><dd><ul id="crm-vip-viprig-dis-classtree_edit"></ul></dd></dl></div></div></div><div class="layui-inline"><label class="layui-form-label">专属折扣</label><div class="layui-input-inline"><input type="text" name="exclusive_discounts" autocomplete="off" class="layui-input"></div><div class="layui-form-mid layui-word-aux">例如:0.95</div></div></div><div class="layui-form-item"><div class="layui-inline"><label class="layui-form-label">专属名称</label><div class="layui-input-inline"><select lay-filter="aihao" name="exclusive_days" id="crm-viprig-dis-add-excdays-edit"></select></div><label class="layui-form-mid">前</label><div class="layui-input-inline"><input type="text" name="limited_time_start" autocomplete="off" class="layui-input"></div><label class="layui-form-mid">天 至 后</label><div class="layui-input-inline"><input type="text" name="limited_time_end" autocomplete="off" class="layui-input"></div><label class="layui-form-mid">天</label></div></div><div class="layui-form-item"><div style="text-align:center"><button class="layui-btn layui-btn-radius" lay-submit lay-filter="crm-vip-viprights-discountSub-edit">提交修改</button></div></div></form>',
                    success: function (layero, index) {
                        // 右上角叉号
                        var elemClose = $('<i class="layui-icon" close>&#x1006;</i>');
                        layero.append(elemClose);
                        elemClose.on('click', function () {
                            layer.close(index);
                        });

                        // form表单渲染
                        form.render(null, 'crm-vip-viprights-discount-edit');

                        admin.req({ // ---------------------------------------------------------------------------------------------清除缓存
                            url: '/index.php/websetCacheNull/',
                            type: 'post',
                            done: function (res) {
                            }
                        });

                        // 将初始数据加入缓存
                        admin.req({
                            url: '/index.php/webDisGoodsCache/',
                            type: 'post',
                            data: { goods: obj.data.project, type: obj.data.type },
                            done: function (res) {

                            }
                        });
                        // 表单初始赋值
                        form.val("crm-vip-viprights-discount-edit", {
                            username: obj.data.username,//规则名称
                            project: obj.data.project,//消费项目
                            // exclusive_days: obj.data.exclusive_days,//专属日期
                            limited_time_start: obj.data.limited_time_start,//专属日期 开始
                            limited_time_end: obj.data.limited_time_end,//专属日期 结束
                            exclusive_discounts: obj.data.exclusive_discounts, //专属折扣
                            // integral_multiple: obj.data.integral_multiple, //积分倍数
                        });


                        initList2('/index.php/webgeTzsdis/','#crm-viprig-dis-add-excdays-edit', data.exclusive_code);
                        initList1('/index.php/webStores/', '#crm-vip-discount-ssdm-edit', data.store_code);
                        initList("/index.php/webDroplevel/", "#crm-vip-discount-hydj-edit", data.level_code);

                        //获取所属类别列表
                        initcategoryTree("#crm-vip-viprig-dis-classtree_edit");
                       
                        // 表单提交事件
                        form.on("submit(crm-vip-viprights-discountSub-edit)", function (data) {
                            var reg = /^(1|0(\.\d{1,2})?)$/;
                            var regs = /(^[1-9]([0-9]+)?(\.[0-9]{1,2})?$)|(^(0){1}$)|(^[0-9]\.[0-9]([0-9])?$)/;
                            var tmsg = '积分倍数格式错误';
                            if (data.field.integral_multiple != '') {
                                if (!regs.test(data.field.integral_multiple)) {   // js正则验证  消费总金额
                                    layer.msg(tmsg, { icon: 2 });
                                    return false;
                                }
                            }
                            if (!reg.test(data.field.exclusive_discounts)) {
                                layer.msg('专属折扣必须是0-1之间的两位小数', { icon: 2, title: '提示' });
                                return false;
                            }
                            admin.req({
                                url: "/index.php/webDiscountEdit/",
                                type: "post",
                                data: {
                                    id: obj.data.id,
                                    username: $.trim(data.field.username),
                                    storefront: data.field.storefront,
                                    level: data.field.level,
                                    project: data.field.project,
                                    exclusive_days: $.trim(data.field.exclusive_days),
                                    limited_time_start: $.trim(data.field.limited_time_start), //专属名称 开始
                                    limited_time_end: $.trim(data.field.limited_time_end), //专属名称 结束
                                    exclusive_discounts: $.trim(data.field.exclusive_discounts)
                                    // integral_multiple: $.trim(data.field.integral_multiple)
                                },
                                done: function (res) {
                                    if (res.msg == 'error') {
                                        layer.msg(res.data, { icon: 2, title: res.msg });
                                    } else if (res.msg == 'yes') {
                                        layer.close(index);
                                        discount('/index.php/webDiscountlist/');
                                        layer.msg(res.data, { icon: 1, title: '提示' });
                                    } else if (res.msg == 'no') {
                                        layer.msg(res.data, { icon: 2, title: '提示' });
                                    }
                                }
                            });
                            return false;
                        });
                    }
                });
            } 
            // else if (obj.event = 'crm-vip-viprights-show') {
            //     layer.open({
            //         title: '消费项目(修改悉知：消费项目修改之后，未勾选的产品将不再显示，一经修改，消费项目只能是产品 不会再是分类，有特殊需求请在编辑中修改)',
            //         type: 1,
            //         shade: 0.3,
            //         shadeClose: false,
            //         anim: 1,
            //         offset: 'auto',
            //         area: ['1000px', '500px'],
            //         skin: "layui-layer-admin layui-anim",
            //         content: '<table class="layui-hide" lay-filter="crm-vip-viprights-discount-show-type-goods" id="crm-vip-viprights-discount-show-type-goods"></table>',
            //         success: function (listLayero, listIndex) {
            //             var elem2Close = $('<i class="layui-icon" close>&#x1006;</i>');
            //             listLayero.append(elem2Close);
            //             elem2Close.on('click', function () {
            //                 layer.close(listIndex);
            //             });
            //             // 列表请求
            //             var gdxfxm_list = function (ids) {
            //                 table.render({
            //                     elem: '#crm-vip-viprights-discount-show-type-goods'
            //                     , height: 390
            //                     , url: '/index.php/webDisProjects/'
            //                     , where: { id: ids, type: obj.data.type, dis: obj.data.exclusive_discounts, access_token: layui.data(layui.setter.tableName).access_token }
            //                     , cols: [[ //表头
            //                         { type: 'checkbox', fixed: 'left' },
            //                         { field: 'bar_code', width: 200, title: '条码', align: 'center' },
            //                         { field: 'frenum', minwidth: 120, title: '货号', align: 'center' },
            //                         { field: 'name', minwidth: 120, title: '商品名', align: 'center' },
            //                         { field: 'unit_name', width: 60, title: '单位', align: 'center' },
            //                         { field: 'color', width: 70, title: '颜色', align: 'center' },
            //                         { field: 'size', width: 70, title: '尺码', align: 'center' },
            //                         { field: 'price', width: 100, title: '价格', align: 'center' },
            //                         { field: 'dis_price', width: 100, title: '折后价格', align: 'center' },
            //                     ]]
            //                     , toolbar: '#crm-vip-viprig-dis-show-toolbar'
            //                 });
            //             }
            //             gdxfxm_list(obj.data.project);

            //             table.on('toolbar(crm-vip-viprights-discount-show-type-goods)', function (objDisGoods) {
            //                 var checkStatus = table.checkStatus(objDisGoods.config.id);
            //                 switch (objDisGoods.event) {
            //                     case 'edit':
            //                         if (checkStatus.isAll == true) {
            //                             layer.msg('未修改', { icon: 2 });
            //                             return false;
            //                         }

            //                         if (checkStatus.data.length < 1) {
            //                             layer.msg('消费项目不能为空', { icon: 2 });
            //                             return false;
            //                         }

            //                         var goods = '';
            //                         for (var i = 0; i < checkStatus.data.length; i++) {
            //                             goods += checkStatus.data[i].code + ',';
            //                         }

            //                         layer.confirm('确认修改？消费项目修改之后，未勾选的产品将不再显示，一经修改，消费项目只能是产品 不会再是分类，有特殊需求请在编辑中修改', { icon: 3, title: '提示' }, function (index) {
            //                             admin.req({
            //                                 url: '/index.php/webDisGoodsEdit/',
            //                                 type: 'post',
            //                                 data: { goods: goods, id: obj.data.id },
            //                                 done: function (res) {
            //                                     if (res.msg == 'error') {
            //                                         layer.msg(res.data, { icon: 2, title: res.msg });
            //                                     } else if (res.msg == 'yes') {
            //                                         layer.msg('成功', { icon: 1, title: '提示' });
            //                                         layer.close(index);
            //                                         // console.log(res.data);return false;
            //                                         gdxfxm_list(res.data);
            //                                         discount('/index.php/webDiscountlist/');
            //                                     } else if (res.msg == 'no') {
            //                                         layer.msg(res.data, { icon: 2, title: '提示' });
            //                                     }
            //                                 }
            //                             });
            //                             return false;
            //                         });
            //                         break;
            //                 };
            //             })
            //         }
            //     });

            // }
        });
    });
</script>